<div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
  <div *ngIf="alert" [ngClass]="{
    'bg-green-50 text-green-800': alert.type === 'success',
    'bg-red-50 text-red-800': alert.type === 'error'
  }" class="fixed top-5 right-5 flex items-center p-4 rounded-lg shadow-lg" role="alert">
    <svg *ngIf="alert.type === 'success'" class="shrink-0 w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" viewBox="0 0 20 20">
      <path
        d="M16.707 5.293a1 1 0 0 0-1.414 0L9 11.586 6.707 9.293a1 1 0 0 0-1.414 1.414l3 3a1 1 0 0 0 1.414 0l7-7a1 1 0 0 0 0-1.414Z" />
    </svg>
    <svg *ngIf="alert.type === 'error'" class="shrink-0 w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg"
      fill="currentColor" viewBox="0 0 20 20">
      <path d="M10 0a10 10 0 1 0 10 10A10 10 0 0 0 10 0Zm1 15H9v-2h2Zm0-4H9V5h2Z" />
    </svg>
    <span class="text-sm font-medium">{{ alert.message }}</span>
  </div>

  <div *ngFor="let publication of publications"
    class="border border-gray-200 rounded-xl hover:shadow-md hover:bg-gradient-to-r from-gray-50 to-transparent p-4 space-y-4 hover:border-gray-300 transition-all duration-300 ease-in-out">
    <!-- Mostrar ícono de publicación fijada -->
    <div class="relative">
      <div *ngIf="publication.fijada" class="absolute -top-6 right-0 text-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16">
          <title>Publicacion fijada</title>
          <path fill="currentColor"
            d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479c-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224 1.5-.5 1.5s-.5-1.224-.5-1.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.189A6 6 0 0 1 5 6.708V2.277a3 3 0 0 1-.354-.298C4.342 1.674 4 1.179 4 .5a.5.5 0 0 1 .146-.354" />
        </svg>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <a (click)="navigateToProfileUser(publication.idUsuario)">
        <img [src]="publication.avatar" alt="Avatar" class="w-10 h-10 rounded-full hover-img-avatar"
          (mouseenter)="showHoverModal(publication.idUsuario, $event)" (mouseleave)="hideHoverModal()" />
      </a>
      <div class="flex-1">
        <a class="flex items-center gap-2" (click)="navigateToProfileUser(publication.idUsuario)">
          <h3 class="text-sm font-semibold text-gray-800 hover:underline">{{ publication.nombreCompleto }}</h3>
          <ng-container *ngIf="publication.tipoRol === 'ADMINISTRADOR'">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
              <title>Usuario administrador</title>
              <path fill="#2b7fff" fill-rule="evenodd"
                d="M21.007 8.27C22.194 9.125 23 10.45 23 12s-.806 2.876-1.993 3.73c.24 1.442-.134 2.958-1.227 4.05c-1.095 1.095-2.61 1.459-4.046 1.225C14.883 22.196 13.546 23 12 23c-1.55 0-2.878-.807-3.731-1.996c-1.438.235-2.954-.128-4.05-1.224c-1.095-1.095-1.459-2.611-1.217-4.05C1.816 14.877 1 13.551 1 12s.816-2.878 2.002-3.73c-.242-1.439.122-2.955 1.218-4.05c1.093-1.094 2.61-1.467 4.057-1.227C9.125 1.804 10.453 1 12 1c1.545 0 2.88.803 3.732 1.993c1.442-.24 2.956.135 4.048 1.227s1.468 2.608 1.227 4.05m-4.426-.084a1 1 0 0 1 .233 1.395l-5 7a1 1 0 0 1-1.521.126l-3-3a1 1 0 0 1 1.414-1.414l2.165 2.165l4.314-6.04a1 1 0 0 1 1.395-.232"
                clip-rule="evenodd" />
            </svg>
          </ng-container>
        </a>
        <div class="flex items-center gap-2">
          <p class="text-xs text-gray-500">{{ publication.nombreCarrera }}</p>
          <div class="flex items-center gap-1 ml-auto">
            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">{{ publication.nombreCategoria
              }}</span>
            <span class="text-xs text-gray-400">• {{ getTimeElapsedWrapper(publication.fechaRegistro) }}</span>

          </div>
        </div>
      </div>
      <div class="relative inline-block text-left"
        *ngIf="isCurrentUserAdmin || publication.idUsuario === currentUserId">
        <div>
          <button type="button" id="option-publication"
            class="hover:bg-gray-100 p-1 rounded-lg transition-colors duration-300" [ngClass]="{
              'text-gray-500': !publication.isDropdownVisible,
              'text-gray-600 bg-gray-200': publication.isDropdownVisible
            }" aria-expanded="true" aria-haspopup="true" (click)="toggleDropdown(publication)">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
              <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 12a1 1 0 1 0 2 0a1 1 0 1 0-2 0m7 0a1 1 0 1 0 2 0a1 1 0 1 0-2 0m7 0a1 1 0 1 0 2 0a1 1 0 1 0-2 0" />
            </svg>
          </button>
        </div>
        <div *ngIf="publication.isDropdownVisible"
          class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black/5 focus:outline-hidden">
          <div class="py-1">
            <!-- Opciones para el administrador -->
            <ng-container *ngIf="isCurrentUserAdmin">
              <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-300"
                (click)="openDeleteModal(publication)">Eliminar</a>
              <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-300"
                (click)="navigateToEditPublication(publication.idPublicacion)">Actualizar</a>
              <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-300"
                (click)="toggleFixPublication(publication)">{{ publication.fijada ? 'Desfijar' : 'Fijar' }}</a>
            </ng-container>

            <!-- Opciones para el propietario de la publicación -->
            <ng-container *ngIf="publication.idUsuario === currentUserId && !isCurrentUserAdmin">
              <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-300"
                (click)="openDeleteModal(publication)">Eliminar</a>
              <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-300"
                (click)="navigateToEditPublication(publication.idPublicacion)">Actualizar</a>
            </ng-container>
          </div>
        </div>
      </div>

    </div>

    <app-hover-avatar *ngIf="isHoverModalVisible" [profileData]="hoverProfileData" [position]="hoverPosition"
      (mouseenter)="onModalMouseEnter()" (mouseleave)="onModalMouseLeave()"></app-hover-avatar>

    <a (click)="navigateToDetailPublication(publication.idPublicacion)" title="Ver mas...">
      <div class="w-full overflow-hidden">
        <div class="group relative h-[260px]" style="scrollbar-gutter: stable both-edges;">
          <div
            class="flex gap-4 overflow-hidden group-hover:overflow-x-auto group-hover:scrollbar-thin group-hover:scrollbar-thumb-blue-500 py-4 h-full">

            <!-- Condición para una sola imagen, video o GIF -->
            <ng-container *ngIf="publication.archivos.length === 1">
              <figure *ngFor="let archivo of publication.archivos; let i = index" class="shrink-0 w-full scroll-touch">
                <div class="overflow-hidden rounded-md">
                  <img *ngIf="archivo.tipo === 'imagen' && !archivo.rutaArchivo.endsWith('.gif')"
                    [src]="archivo.rutaArchivo" alt="Media" class="aspect-square h-54 w-full object-cover" />

                  <img *ngIf="archivo.tipo === 'gif' && archivo.rutaArchivo.endsWith('.gif')"
                    [src]="archivo.rutaArchivo" alt="GIF" class="aspect-square h-54 w-full object-cover" />

                  <video *ngIf="archivo.tipo === 'video'" controls class="aspect-square h-54 w-full object-cover">
                    <source [src]="archivo.rutaArchivo" type="video/mp4" />
                    Tu navegador no soporta la etiqueta de video.
                  </video>
                </div>
              </figure>
            </ng-container>
            <!-- Condición para múltiples archivos -->
            <ng-container *ngIf="publication.archivos.length > 1">
              <div class="flex sm:overflow-visible overflow-x-auto gap-4 px-1">

                <figure *ngFor="let archivo of publication.archivos; let i = index" class="shrink-0">
                  <div class="overflow-hidden rounded-md">

                    <img *ngIf="archivo.tipo === 'imagen'" [src]="archivo.rutaArchivo" alt="Media"
                      class="aspect-square h-54 w-54 object-cover" />

                    <img *ngIf="archivo.tipo === 'gif' && archivo.rutaArchivo.endsWith('.gif')"
                      [src]="archivo.rutaArchivo" alt="GIF" class="aspect-square h-54 w-54 object-cover" />

                    <video *ngIf="archivo.tipo === 'video'" controls class="aspect-square h-54 w-54 object-cover">
                      <source [src]="archivo.rutaArchivo" type="video/mp4" />
                      Tu navegador no soporta la etiqueta de video.
                    </video>
                  </div>
                </figure>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </a>
    <!-- Contenido -->
    <div>
      <a (click)="navigateToDetailPublication(publication.idPublicacion)" title="Ver mas...">
        <h4 class="font-semibold truncate text-gray-900 text-sm">{{ publication.titulo }}</h4>
        <div class="text-gray-600 text-sm mt-1 clamped" [innerHTML]="publication.contenido"></div>
      </a>
    </div>

    <app-modal-users-by-reaction-type *ngIf="publication.isReactionModalVisible"
      [reactionType]="publication.reactionType" [users]="publication.reactionUsers"
      [position]="publication.hoverPosition" (mouseenter)="onModalMouseEnter()"
      (mouseleave)="onModalMouseLeaveReaction(publication)">
    </app-modal-users-by-reaction-type>

    <app-totals-reaction-comment [idPublicacion]="publication.idPublicacion"
      [totalComentarios]="publication.totalComentarios ?? 0" [reacciones]="publication.reacciones"
      (hoverReaction)="openReactionHover($event, publication)" (leaveReaction)="closeReactionHover(publication)"
      (hoverComments)="openCommentHover($event, publication)" (leaveComments)="closeCommentHover(publication)">
    </app-totals-reaction-comment>

    <app-modal-user-comment-publication *ngIf="publication.isCommentModalVisible"
      [usersComment]="publication.usersComment ?? []" [position]="publication.commentHoverPosition ?? null"
      (mouseenter)="onModalMouseEnter()" (mouseleave)="onModalMouseLeaveComment(publication)">
    </app-modal-user-comment-publication>

    <app-reaction [idUsuario]="currentUserId ?? ''" [idPublicacion]="publication.idPublicacion"
      (reactionChanged)="updateReactions(publication.idPublicacion)">
    </app-reaction>

    <app-login-modal *ngIf="isLoginModalVisible$ | async"></app-login-modal>

    <app-complete-info-register-google *ngIf="isInfoCompleteModalVisible$ | async"></app-complete-info-register-google>
  </div>

  <div *ngIf="isDeleteModalVisible" class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div
          class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="sm:flex sm:items-start">
              <div
                class="mx-auto flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>
              </div>
              <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                <h3 class="text-base font-semibold text-gray-900" id="modal-title">Eliminar publicación</h3>
                <div class="mt-2">
                  <p class="text-sm text-gray-500">¿Estás seguro de que deseas eliminar esta publicación? Esta acción no
                    se puede deshacer.</p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
            <button type="button"
              class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-xs hover:bg-red-500 sm:ml-3 sm:w-auto"
              (click)="confirmDelete()">Eliminar</button>
            <button type="button"
              class="mt-3 inline-flex w-full justify-center rounded-md px-4 py-2 text-sm font-semibold text-gray-900 shadow-xs ring-1 ring-gray-300 ring-inset hover:ring-gray-400 sm:mt-0 sm:w-auto"
              (click)="closeDeleteModal()">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="flex justify-center items-center mt-4">
    <svg fill="currentColor" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z">
        <animateTransform attributeName="transform" type="rotate" dur="0.75s" values="0 12 12;360 12 12"
          repeatCount="indefinite" />
      </path>
    </svg>
  </div>
</div>